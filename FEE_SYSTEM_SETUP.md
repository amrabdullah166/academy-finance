# دليل إعداد نظام الرسوم

## الخطوات المطلوبة لتفعيل نظام الرسوم

### 1. تطبيق Schema على قاعدة البيانات

قم بتنفيذ ملف `database/fees-system.sql` على قاعدة بيانات Supabase:

1. افتح Supabase Dashboard
2. اذهب إلى SQL Editor
3. انسخ محتوى ملف `database/fees-system.sql`
4. قم بتنفيذ الأوامر

أو استخدم هذا الأمر إذا كان لديك Supabase CLI:
```bash
supabase db push
```

### 2. التحديثات التي تمت

#### صفحة الكورسات (`src/app/courses/page.tsx`)
- ✅ إضافة حقل رسوم التسجيل (registration_fee)
- ✅ إضافة حقل رسوم المواصلات (transportation_fee)
- ✅ تحديث نموذج إضافة/تعديل الكورس
- ✅ إضافة أعمدة الرسوم في جدول الكورسات

#### صفحة التسجيل (`src/app/enrollments/page.tsx`)
- ✅ إضافة خيار المواصلات (checkbox)
- ✅ عرض رسوم المواصلات في قائمة الكورسات
- ✅ حساب الرسوم الإجمالية عند التسجيل

#### مكتبة Supabase (`src/lib/supabase.ts`)
- ✅ تحديث دالة `enrollStudentInCourse` لتقبل معامل المواصلات
- ✅ حساب الرسوم الشهرية تلقائياً (رسوم الكورس + رسوم المواصلات)
- ✅ حفظ معلومات رسوم التسجيل

#### قاعدة البيانات (`database/fees-system.sql`)
- ✅ إضافة أعمدة الرسوم لجدول courses
- ✅ إضافة أعمدة تتبع الرسوم لجدول student_courses
- ✅ إنشاء جدول monthly_payments للمدفوعات الشهرية
- ✅ إضافة triggers لإنشاء المدفوعات الشهرية تلقائياً
- ✅ إضافة RLS policies للأمان

### 3. الميزات الجديدة

#### أنواع الرسوم
1. **رسوم التسجيل (Registration Fee)**:
   - تدفع مرة واحدة عند التسجيل
   - اختيارية (يمكن أن تكون صفر)
   - تُحفظ في جدول student_courses

2. **الرسوم الشهرية (Monthly Fee)**:
   - تدفع شهرياً
   - إلزامية لكل كورس
   - يتم إنشاء 12 سجل دفع تلقائياً عند التسجيل

3. **رسوم المواصلات (Transportation Fee)**:
   - اختيارية (يختارها الطالب عند التسجيل)
   - تُضاف للرسوم الشهرية إذا تم اختيارها
   - تظهر منفصلة في التقارير

#### التتبع التلقائي
- **Trigger**: عند تسجيل طالب جديد، يتم إنشاء 12 سجل دفع شهري تلقائياً
- **حالة الدفع**: تتحدث تلقائياً عند إضافة دفعة في جدول payments
- **الفلترة**: يمكن عرض المدفوعات المستحقة/المدفوعة/المتأخرة

### 4. الخطوات التالية المقترحة

#### صفحة المدفوعات الشهرية (اختياري)
إنشاء صفحة جديدة لعرض المدفوعات الشهرية:
- عرض جميع المدفوعات المستحقة
- فلترة حسب الحالة (مدفوع/غير مدفوع/متأخر)
- إمكانية تسجيل دفعة مباشرة
- تقارير بالمدفوعات الشهرية

#### تحسينات صفحة المدفوعات
- عرض رسوم التسجيل منفصلة
- تمييز المدفوعات الشهرية
- إظهار المدفوعات المتأخرة

#### تقارير مالية محسّنة
- تقرير الإيرادات حسب نوع الرسوم
- تقرير المدفوعات المستحقة
- تقرير المدفوعات المتأخرة

### 5. كيفية الاستخدام

#### إضافة كورس جديد
1. اذهب إلى صفحة الكورسات
2. اضغط "إضافة كورس جديد"
3. أدخل:
   - اسم الكورس
   - الرسوم الشهرية (إلزامي)
   - رسوم التسجيل (اختياري)
   - رسوم المواصلات (اختياري)
4. احفظ

#### تسجيل طالب في كورس
1. اذهب إلى صفحة التسجيل
2. اختر الطالب
3. اختر الكورس
4. إذا كان الكورس يوفر مواصلات، سيظهر خيار "إضافة خدمة المواصلات"
5. اضغط "تسجيل الطالب"
6. سيتم تلقائياً:
   - حساب الرسوم الشهرية (مع أو بدون مواصلات)
   - حفظ رسوم التسجيل
   - إنشاء 12 سجل دفع شهري

#### تتبع المدفوعات
- المدفوعات الشهرية تُحدّث تلقائياً عند إضافة دفعة
- يمكنك عرض حالة كل شهر (مدفوع/غير مدفوع)
- المدفوعات المتأخرة تظهر بلون مميز

### 6. ملاحظات مهمة

⚠️ **قبل التطبيق على Production**:
- تأكد من عمل نسخة احتياطية من قاعدة البيانات
- اختبر النظام على بيئة تطوير أولاً
- تحقق من صلاحيات المستخدمين (RLS policies)

📌 **البيانات الموجودة**:
- الكورسات الحالية ستحصل على قيم افتراضية (0) للرسوم الجديدة
- التسجيلات الحالية ستحتاج لتحديث يدوي إذا أردت إضافة المدفوعات الشهرية لها
- يمكنك تعديل الكورسات لإضافة الرسوم

🔒 **الأمان**:
- جميع الجداول محمية بـ RLS policies
- المستخدمون المصرح لهم فقط يمكنهم القراءة/الكتابة
- Triggers محمية ولا يمكن تعديلها مباشرة

### 7. استعلامات مفيدة

#### عرض المدفوعات المستحقة هذا الشهر
```sql
SELECT 
  s.name as student_name,
  c.name as course_name,
  mp.month,
  mp.amount,
  mp.status
FROM monthly_payments mp
JOIN student_courses sc ON mp.enrollment_id = sc.id
JOIN students s ON sc.student_id = s.id
JOIN courses c ON sc.course_id = c.id
WHERE mp.month = EXTRACT(MONTH FROM CURRENT_DATE)
  AND mp.year = EXTRACT(YEAR FROM CURRENT_DATE)
  AND mp.status = 'unpaid'
ORDER BY s.name;
```

#### إحصائيات الرسوم لكورس معين
```sql
SELECT 
  c.name,
  COUNT(sc.id) as total_students,
  SUM(CASE WHEN sc.registration_fee_paid THEN sc.registration_fee ELSE 0 END) as registration_revenue,
  SUM(mp.amount) FILTER (WHERE mp.status = 'paid') as monthly_revenue,
  COUNT(*) FILTER (WHERE sc.has_transportation) as students_with_transportation
FROM courses c
LEFT JOIN student_courses sc ON c.id = sc.course_id
LEFT JOIN monthly_payments mp ON sc.id = mp.enrollment_id
WHERE c.id = 'YOUR_COURSE_ID'
GROUP BY c.id, c.name;
```

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من console.log في المتصفح
2. تحقق من Supabase logs
3. تأكد من تطبيق جميع الأوامر SQL بنجاح
